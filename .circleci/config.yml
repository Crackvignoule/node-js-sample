version: 2.1

jobs:
  say-hello:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: "Say hello"
          command: "echo Hello, World!"

  build-docker:
    machine:
      image: ubuntu-2404:current
    steps:
      - checkout
      - run:
          name: Build Docker image
          command: |
            docker build -t node-js-sample .
      - run:
          name: Save image as tar
          command: |
            docker image save node-js-sample | gzip > node-js-sample.tar.gz
      - persist_to_workspace:
          root: .
          paths:
            - node-js-sample.tar.gz

  test-docker:
    machine:
      image: ubuntu-2404:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Load Docker image
          command: |
            gunzip -c node-js-sample.tar.gz | docker load
      - run:
          name: Run Docker container
          command: |
            docker run -d -p 8080:8080 node-js-sample
      - run:
          name: Test Docker container
          command: |
            sleep 10 && curl -f http://localhost:8080

  push-docker:
    machine:
      image: ubuntu-2404:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Login to DockerHub
          command: |
            echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
      - run:
          name: Push Docker image to DockerHub
          command: |
            docker tag node-js-sample $DOCKERHUB_USERNAME/node-js-sample:latest
            docker push $DOCKERHUB_USERNAME/node-js-sample:latest

workflows:
  docker-workflow:
    jobs:
      - say-hello
      - build-docker
      - test-docker:
          requires:
            - build-docker
      - push-docker:
          requires:
            - test-docker